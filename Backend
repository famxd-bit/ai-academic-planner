from flask import Flask, request, jsonify
from flask_cors import CORS
import math

app = Flask(__name__)
CORS(app)

@app.route("/generate-plan", methods=["POST"])
def generate_plan():
    data = request.json

    subjects = data["subjects"]
    hours = int(data["hours"])
    days_left = int(data["days_left"])

    # Workload score (AI-style logic)
    workload = 0
    for s in subjects:
        workload += int(s["difficulty"]) * 2

    urgency = workload / max(days_left, 1)

    stress = "High" if urgency > 5 or hours < 3 else "Normal"

    # Priority-based plan
    subjects_sorted = sorted(subjects, key=lambda x: x["difficulty"], reverse=True)

    plan = []
    for s in subjects_sorted:
        plan.append({
            "subject": s["name"],
            "hours": round(hours / len(subjects), 1)
        })

    return jsonify({
        "study_plan": plan,
        "stress": stress,
        "workload_score": round(urgency, 2)
    })

@app.route("/chatbot", methods=["POST"])
def chatbot():
    msg = request.json["message"].lower()

    if "study" in msg:
        reply = "Focus on high-difficulty subjects first today."
    elif "stress" in msg:
        reply = "Your workload is high. Take a short break."
    elif "break" in msg:
        reply = "Try the 25â€“5 Pomodoro technique."
    else:
        reply = "Stay consistent. Small steps matter."

    return jsonify({"reply": reply})

if __name__ == "__main__":
    app.run(debug=True)
